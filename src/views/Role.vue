<template>
  <div class="role-manage">
    <div class="query-form">
      <el-form ref="form" :inline="true" :model="queryForm">
        <el-form-item label="ËßíËâ≤ÂêçÁß∞" prop="roleName">
          <el-input v-model="queryForm.roleName" placeholder="ËØ∑ËæìÂÖ•ËßíËâ≤ÂêçÁß∞" />
        </el-form-item>
        <el-form-item>
          <el-button type="primary" @click="getRoleList">Êü• ËØ¢</el-button>
          <el-button @click="handleReset('form')">Èáç ÁΩÆ</el-button>
        </el-form-item>
      </el-form>
    </div>

    <div class="base-table">
      <div class="action">
        <el-button type="primary" @click="handleAdd" v-has="'role-create'">Âàõ Âª∫</el-button>
      </div>
      <!-- Ê∏≤ÊüìÊ†ëÂΩ¢ËèúÂçïË¶ÅÊåáÂÆö row-key -->
      <el-table :data="roleList">
        
        <el-table-column v-for="item in columns" :key="item.prop" :prop="item.prop" :label="item.label"
          :width="item.width" :formatter="item.formatter">
        </el-table-column>
        <el-table-column label="Êìç‰Ωú" width="270">
          <template #default="scope">
            <el-button size="default" @click="handleEdit(scope.row)" v-has="'role-edit'">Áºñ Ëæë</el-button>
            <el-button size="default" @click="handleOpenPermission(scope.row)" v-has="'role-edit-power'">ËÆæÁΩÆÊùÉÈôê</el-button>
            <el-button size="default" type="danger" @click="handleDel(scope.row._id)" v-has="'role-delete'">Âà† Èô§</el-button>
          </template>
        </el-table-column>
      </el-table>
    </div>
    
    <!-- ÂàÜÈ°µÂô® -->
    <div class="pagination-container">
      <el-pagination class="pagination" background layout="prev, pager, next, jumper" :total="pager.total"
        :page-size="pager.pageSize" @current-change="handleCurrentChange" />
    </div>

    <!-- ÂºπÁ™ó -->
    <el-dialog title="ËßíËâ≤Êñ∞Â¢û" v-model="showModal" @close="handleClose">
      <el-form ref="dialogForm" :model="roleForm" label-width="100px" :rules="rules">

        <el-form-item label="ËßíËâ≤ÂêçÁß∞" prop="roleName">
          <el-input v-model="roleForm.roleName" placeholder="ËØ∑ËæìÂÖ•ËßíËâ≤ÂêçÁß∞" />
        </el-form-item>
        <el-form-item label="ËßíËâ≤Â§áÊ≥®" prop="remark">
          <el-input type="textarea" :rows="3" v-model="roleForm.remark" placeholder="ËØ∑ËæìÂÖ•Â§áÊ≥®" />
        </el-form-item>
      </el-form>
      <template #footer>
        <span class="dialog-footer">
          <el-button @click="handleClose">Âèñ Ê∂à</el-button>
          <el-button type="primary" @click="handleSubmit">Á°Æ ÂÆö</el-button>
        </span>
      </template>
    </el-dialog>

    <!-- ÊùÉÈôêÂºπÁ™ó -->
    <el-dialog title="ÊùÉÈôêËÆæÁΩÆ" v-model="showPermissionModal">
      <el-form label-width="100px">

        <el-form-item label="ËßíËâ≤ÂêçÁß∞">
          {{ curRoleName }}
        </el-form-item>
        <el-form-item label="ÈÄâÊã©ÊùÉÈôê">
          <!-- treeÊ†ëÂΩ¢Êéß‰ª∂ -->
          <el-tree ref="treeRef" style="max-width: 600px" :data="menuList" show-checkbox default-expand-all
            node-key="_id" highlight-current :props="{ label: 'menuName' }" />

        </el-form-item>
      </el-form>
      <template #footer>
        <span class="dialog-footer">
          <el-button @click="showPermissionModal = false">Âèñ Ê∂à</el-button>
          <el-button type="primary" @click="handlePermissionSubmit">Á°Æ ÂÆö</el-button>
        </span>
      </template>
    </el-dialog>

  </div>
</template>

<script>
import utils from "@/utils/utils";
import { ElMessage } from "element-plus";

export default {

  name: "role",

  data() {
    return {
      //ÂÆö‰πâÊü•ËØ¢Ë°®Âçï
      queryForm: {
        roleName: '',
      },
      action: '',
      roleList: [],

      columns: [
        {
          label: "ËßíËâ≤ÂêçÁß∞",
          prop: "roleName",
        },
        {
          label: "Â§áÊ≥®",
          prop: "remark",
        },
        {
          label: "ÊùÉÈôêÂàóË°®",
          prop: "permissionList",

          //Ê≠§Â§ÑÁî®ÁÆ≠Â§¥ÂáΩÊï∞‰ΩøÂæóthisÊåáÂêëVueÁªÑ‰ª∂ÂÆû‰æã
          formatter: (row, column, value) => {
            let names = [];
            let list = value.halfCheckedKeys || [];
            list.map((key) => {
              let name = this.actionMap[key];
              if (key && name !== 'Á≥ªÁªüÁÆ°ÁêÜ' && name !== 'ÂÆ°ÊâπÁÆ°ÁêÜ') names.push(name);
            });
            return names.join(",");
          },
        },

        {
          label: "Êõ¥Êñ∞Êó∂Èó¥",
          prop: "updateTime",
          formatter(row, column, value) {
            return utils.formateDate(new Date(value)); //new‰∏Ä‰∏™DateÂØπË±°,ÁÑ∂ÂêéÊääÊó∂Èó¥Êà≥‰º†ËøõÂéª 
          },
        },
        {
          label: "ÂàõÂª∫Êó∂Èó¥",
          prop: "createTime",
          formatter(row, column, value) {
            return utils.formateDate(new Date(value)); //new‰∏Ä‰∏™DateÂØπË±°,ÁÑ∂ÂêéÊääÊó∂Èó¥Êà≥‰º†ËøõÂéª 
          },
        },

      ],

      //ÂàÜÈ°µ
      pager: {
        pageNum: 1,
        pageSize: 10,
        total: 0,
      },

      //ÂºπÁ™óÊòæÁ§∫ÊéßÂà∂
      showModal: false,
      showPermissionModal: false,
      roleForm: {},

      //Ë°®ÂçïÈ™åËØÅËßÑÂàô
      rules: {
        roleName: [
          { required: true, message: 'ËØ∑ËæìÂÖ•Áî®Êà∑Âêç', trigger: 'blur' },  //Ê∑ªÂä†Ê≠£Âàô //trigger Ë°®Á§∫Ëß¶ÂèëÈ™åËØÅÁöÑÊó∂Êú∫
        ],
      },
      //ÁºñËæëÊùÉÈôêÂºπÁ™óÂ±ûÊÄß
      curRoleId: '',
      curRoleName: '',
      menuList: [],

      //ÊùÉÈôêËèúÂçïÊò†Â∞ÑË°®
      actionMap: {},

    };
  },
  mounted() {
    this.getRoleList();
    this.getMenuList();
  },

  methods: {
    // ËßíËâ≤ÂàóË°®ÂàùÂßãÂåñ
    async getRoleList() {
      try {
        let { list, page } = await this.$api.getRoleList({ ...this.queryForm, ...this.pager });
        this.roleList = list;
        this.pager.total = page.total; //Êï∞ÊçÆÂåÖÂê´ÂàÜÈ°µ‰ø°ÊÅØÔºåË¶ÅËÆæÁΩÆÂàÜÈ°µÂèòÈáèÊé•Êî∂
      } catch (e) {
        throw new Error(e);
      }
    },

    // ËèúÂçïÂàóË°®ÂàùÂßãÂåñ
    async getMenuList() {
      try {
        let list = await this.$api.getMenuList();
        this.menuList = list;
        this.getActionMap(list);
      } catch (e) {
        throw new Error(e);
      }
    },

    // Êü•ËØ¢‰ø°ÊÅØÈáçÁΩÆ
    handleReset(form) {
      this.$refs[form].resetFields(); // ÈÄöÁî®ÈáçÁΩÆË°®ÂçïÊñπÊ≥ï
    },
    // Êñ∞Â¢ûËßíËâ≤
    handleAdd() {
      this.showModal = true;
      this.action = "create";

    },

    // ÁºñËæëËßíËâ≤
    handleEdit(row) {
      this.showModal = true;
      this.action = "edit";
      // VueÂºÇÊ≠•Êõ¥Êñ∞Êú∫Âà∂
      // Á≠âÂæÖDOMÊõ¥Êñ∞ÂêéÊâßË°å
      this.$nextTick(() => {
        this.roleForm = { roleName: row.roleName, remark: row.remark, _id: row._id };
      });
    },

    // Âà†Èô§ËßíËâ≤
    async handleDel(_id) {
      const res = await this.$api.roleOperate({ _id, action: "delete" }); // ‚úÖ Ê≠£Á°ÆÁöÑAPI
      if (res) {
        ElMessage.success("Âà†Èô§ÊàêÂäü");
        this.getRoleList();
      } else {
        ElMessage.error(res.msg || "Âà†Èô§Â§±Ë¥•");
      }
    },

    // ËßíËâ≤Êìç‰Ωú-Êèê‰∫§
    handleSubmit() {
      //dialogForm‰∏∫Ë°®ÂçïÁöÑref,‰∏äÈù¢Â∑≤ÁªèÂÆö‰πâ 
      this.$refs.dialogForm.validate(async (valid) => {
        if (valid) {
          let { action, roleForm } = this; //ÈÄöËøáthisËé∑ÂèñË°®ÂçïÊï∞ÊçÆ
          let params = { ...roleForm, action };
          let res = await this.$api.roleOperate(params);
          if (res) {
            this.showModal = false;
            ElMessage.success("Êìç‰ΩúÊàêÂäü");
            this.handleReset("dialogForm");
            this.getRoleList();
          } else {
            ElMessage.error(res.msg || "Êìç‰ΩúÂ§±Ë¥•");
          }

        }
      })
    },

    // ÂºπÊ°ÜÂÖ≥Èó≠
    handleClose() {
      this.showModal = false;
      this.handleReset("dialogForm");
      
    },

    // ÂàÜÈ°µÂô®ÂàáÊç¢‰∫ã‰ª∂
    handleCurrentChange(current) {
      this.pager.pageNum = current; // ÂàÜÈ°µÁªÑ‰ª∂Ëß¶Âèëcurrent-change‰∫ã‰ª∂Êó∂Ôºå‰ºöÂ∞ÜÂΩìÂâçÈ°µÁ†Å‰Ωú‰∏∫Á¨¨‰∏Ä‰∏™ÂèÇÊï∞‰º†ÂÖ•Â§ÑÁêÜÂáΩÊï∞„ÄÇ
      this.getRoleList();
    },
    // ÁºñËæëÊùÉÈôê
    handleOpenPermission(row) {
      this.curRoleId = row._id;
      this.curRoleName = row.roleName;
      this.showPermissionModal = true;
      let { checkedKeys } = row.permissionList;
      this.$nextTick(() => {
        this.$refs.treeRef.setCheckedKeys(checkedKeys); // treeÊ†ëÂΩ¢Êéß‰ª∂Êèê‰æõÁöÑsetCheckedKeys:ËÆæÁΩÆÁõÆÂâçÈÄâ‰∏≠ÁöÑËäÇÁÇπ
      });
    },
    //ÊùÉÈôêËÆæÁΩÆË°®ÂçïÂºπÂá∫Êèê‰∫§
    async handlePermissionSubmit() {
      let nodes = this.$refs.treeRef.getCheckedNodes();
      let halfKeys = this.$refs.treeRef.getHalfCheckedKeys();
      let checkedKeys = [];
      let parentKeys = [];
      nodes.map(node => {
        if (!node.children) {
          checkedKeys.push(node._id);
        } else {
          parentKeys.push(node._id);
        }
      });
      let params = {
        _id: this.curRoleId,
        permissionList: {
          checkedKeys: checkedKeys,
          halfCheckedKeys: parentKeys.concat(halfKeys),
        }
      };
      await this.$api.roleUpdatePermission(params);
      this.showPermissionModal = false;
      ElMessage.success('ÊùÉÈôêËÆæÁΩÆÊàêÂäü');
      this.getRoleList();
    },

    // ÈÄíÂΩíËé∑ÂèñÊùÉÈôêÊåâÈíÆÂàóË°®  Ê∑±Â∫¶‰ºòÂÖàÈÅçÂéÜÔºàDFSÔºâ
    // getActionMap(list) {
    //   const actionMap = {};
    //   const deep = (arr) => {
    //     while (arr.length) {
    //       let item = arr.pop();  // pop Âà†Èô§Âπ∂ËøîÂõûÊï∞ÁªÑÁöÑÊúÄÂêé‰∏Ä‰∏™ÂÖÉÁ¥†
    //       if (item.action && item.children) {
    //         actionMap[item._id] = item.menuName;
    //       }
    //       if (item.children && !item.action) {
    //         deep(item.children);
    //       }
    //     }
    //   }
    //   deep(JSON.parse(JSON.stringify(list))); //Ê∑±Êã∑Ë¥ù
    //   //deep(cloneDeep(list)); // Êõ¥ÂÆâÂÖ®ÁöÑÊ∑±Êã∑Ë¥ù
    //   this.actionMap = actionMap;
    // },
    getActionMap(list) {
      const actionMap = {};
      const deep = (arr) => {
        while (arr.length) {
          const item = arr.pop();

          // üî¥ 1. Â§ÑÁêÜÁà∂ËäÇÁÇπÁöÑactionÊï∞ÁªÑÔºàÊåâÈíÆÊùÉÈôêÔºâ
          if (item.action) {
            item.action.forEach(btn => {
              actionMap[btn._id] = btn.menuName;
            });
          }

          // üî¥ 2. Â§ÑÁêÜÂΩìÂâçËäÇÁÇπÊú¨Ë∫´ÔºàËèúÂçïÊàñÊåâÈíÆÔºâ
          actionMap[item._id] = item.menuName; // Áõ¥Êé•ËÆ∞ÂΩïÂΩìÂâçËäÇÁÇπÂêçÁß∞

          // üî¥ 3. ÈÄíÂΩíÂ§ÑÁêÜÂ≠êËäÇÁÇπ
          if (item.children) {
            deep(item.children);
          }
        }
      };

      deep(JSON.parse(JSON.stringify(list))); // Ê∑±Êã∑Ë¥ùÈò≤Ê≠¢‰øÆÊîπÂéüÂßãÊï∞ÊçÆ
      this.actionMap = actionMap;
    }
  }
}


</script>



<style lang="scss">
.el-form {
  .el-form-item {
    .el-select {
      width: 200px;
    }
  }
}
</style>